<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>basket.js - a simple script loader that caches scripts with localStorage</title>
	</head>
	<link rel="stylesheet" type="text/css" href="asset/base.css">
	<body>

	<div id="container">
		<h1><img src="asset/logo.png" style="width:450px;" alt="basket.js"/> </h1>
		<h2>A simple (proof-of-concept) script loader that caches scripts with localStorage </h2>
		<p>
		    <strong>Version 0.3: </strong> 
			<a href="dist/basket.js">basket.js</a> (4.6KB) &nbsp;
			<a href="dist/basket.min.js">basket.min.js</a> (1KB gzipped) &nbsp;
			<a href="https://twitter.com/share" class="twitter-share-button" data-text="basket.js - a simple script loader that caches scripts with localStorage" data-via="addyosmani">Tweet</a>
		</p>

		<div id="message" class="content"><p><strong>If you're seeing this message, something has gone wrong. Please ensure you are testing this page using a HTTP server.</strong></p></div>
		<div class="content">

<h3>Introduction</h3>

<p>basket.js is a small JavaScript library supporting localStorage caching of scripts. If script(s) have previously been saved locally, they will simply be loaded and injected into the current document. If not, they will be XHR'd in for use right away, but cached so that no additional loads are required in the future.</p>

<h3>Why localStorage?</h3>

<p><a href="http://www.stevesouders.com/blog/2011/03/28/storager-case-study-bing-google/">Tests</a> by Google and Bing have shown that there are performance benefits to caching assets in localStorage (especially on mobile) when compared to simply reading and writing from the standard browser cache. This project is currently working on replicating these tests in the public so that we have definitive statistics on whether this is true. </p>

<p>Developers have also been wondering why we opted for localStorage as opposed to alternatives such as IndexedDB. Jens Arps has shown that IDB is at present <a href="http://jsperf.com/indexeddb-vs-localstorage/2">significantly slower</a> than localStorage for reading and writing assets. Other developers exploring this space have also shown that localStorage works just fine for caching data (it's actually significantly <a href="http://www.webdirections.org/blog/localstorage-perhaps-not-so-harmful/">faster</a> in Safari at the moment than any other browser). </p>

<p>We believe that in time, once implementers have optimized localStorage, it will become more feasible to use cross-browser. In the mean time, we are also exploring solutions such as the <a href="http://www.html5rocks.com/en/tutorials/file/filesystem/">FileSystem API</a> as a storage mechanism for caching scripts locally.</p>

<h3>Project History</h3>

<p>This project was created as a response to a <a href="https://twitter.com/#!/souders/statuses/166928191649357824">tweet</a> by Steve Souders asking that the jQuery project consider caching jQuery in localStorage for performance reasons. Intrigued by the idea, we began exploring a minimalistic solution to it (just for the sake of experimentation).</p>

<p>You may remember Souders previously did research and a <a href="http://www.stevesouders.com/blog/2011/03/28/storager-case-study-bing-google/">write-up</a> on search engines making use of localStorage caching back in 2011. His conclusions were:</p>

<p><strong>Bing and Google Search make extensive use of localStorage for stashing SCRIPT blocks that are used on subsequent page views. None of the other top sites from my previous post use localStorage in this way. Are Bing and Google Search onto something? Yes, definitely.</strong></p>

<p>To help provide a more general solution for this problem, we put together a script loader that treats localStorage as a cache.</p>

<h3>Compatibility</h3>

<p>basket.js supports locally caching scripts in any browser with <a href="http://caniuse.com/#search=localstorage">localStorage capabilities</a>.</p>

<h3>API And Examples</h3>

<p>Let's briefly review the current basket.js API, which differs from the API supported in 0.2.</p>

<ul>
<li><strong>basket.require()</strong></li>
<li><strong>basket.get()</strong></li>
<li><strong>basket.remove()</strong></li>
<li><strong>basket.wait()</strong></li>
<li><strong>basket.clear()</strong></li>
</ul>

<p><strong>basket.require( objects )</strong></p>

<p><em>objects:</em> One or more plain JavaScript objects to configure the require operation.</p>
<dl>
	<dt>url</dt>
		<dd><strong>Required</strong> Relative URI to a local script.</dd>
	<dt>key</dt>
		<dd><strong>Optional</strong> Use this to define an alternative name, will default to <em>uri.</em></dd>
	<dt>expire</dt>
		<dd><strong>Optional</strong> Set a lifespan of file cache in localStorage in hours.</dd>
	<dt>execute</dt>
		<dd><strong>Optional</strong> Defaults to 'true'. Set to 'false' to only cache, but not execute the file.</dd>
	<dt>unique</dt>
		<dd><strong>Optional</strong> Used to bust a cached file.</dd>
</dl>

<p><code>.require()</code> allows us to construct loader chains, each of which instruct basket.js to fetch (either externally or from a localStorage cached-copy) a script defined by a supplied uri. The basic loading of a single uri could be achieved as follows:</p>

<pre><code>basket.require({ url: 'jquery.js' });</code></pre>

<p>This will check to see if an item with the key <code>basket-jquery.js</code> exists in localStorage (i.e a cached copy of the script). If present, the script contents are read from storage and injected into the current page. If not present, the script will be fetched, cached in storage and then similarly injected into the document for use.</p>

<p>basket.js also supports chaining and so requesting multiple scripts is also straight-forward:</p>

<pre><code>basket.require({ url: 'jquery.js' }, { url: 'underscore.js' }, { url: 'backbone.js' });</code></pre>

<p>The HTML5 spec suggests storage quota with the limit of 5MB for localStorage. Which means browsers can implement their own quota. Basket.js will handle exceeded quota by removing oldest entries on load and when browser throws QUOTA_EXCEEDED_ERR error. Some browsers like Opera will ask the user about increasing the quota when it exceeds a set threshold.</p>

<p>basket.js will remove only your own entries. The space consumed by other code in same origin will not be touched.</p>

<p>Note that at present, JSONP/server-side middleware is necessary for the support of remote scripts. This is down to access of script content being limited under cross-origin policies.</p>

<p>If you wish to store a script under a specific key name (e.g if you have a build process outputting a script of a name such as <code>012345.js</code> and would like to store it under say, <code>main</code>), this could be done as follows:</p>

<pre><code>basket.require({ url: '012345.js', key: 'main' });</code></pre>

<p>Similarly, if you wish to store <code>jquery-1.7.1.min.js</code> as <code>jquery</code>, this can be done as well:</p>

<pre><code>basket.require({ url: 'jquery-1.7.1.min.js', key: 'jquery' });</code></pre>

<p><strong> If <code>key</code> is unset, the url will be used as key.</strong></p>

<p>You can use <code>expire</code> to set a lifetime in hours for a cached file. The script will be re-fetched if required after this time.</p>
<p>To re-fetch after 7 days you could set 168 ( i.e. 7 * 24 = 168 ).</p>
<p>If <code>expire</code> is unset, the default time will be used. ( i.e. 5000 hours, almost 7 months )</p>

<pre><code>basket.require({ url: 'jquery.min.js', expire: 2 });</code> </pre>


<p>The <code>execute</code> allow put a file in cache without inject into the document</p>

<pre><code>basket.require({ url: 'jquery.min.js', execute: false });</code> </pre>


<p>Set the <code>unique</code> to control a version from file cached. Modifying the parameter, the file is fetched again.</p>
<p>basket.js will add the "basket-unique" parameter on url to prevent browse cache.</p>

<pre><code>basket.require({ url: 'jquery.min.js' }); /* fetch and cache the file */</code> </pre>
<pre><code>basket.require({ url: 'jquery.min.js', unique: 123 }); /* fetch and cache again */</code> </pre>


<p><strong>basket.get( key )</strong></p>

<p><em>key:</em> The key value to retrieve info from specific local script in localStorage.</p>

<p><code>get()</code> will return an object if script is found or false if not</p>
<p>The object retuned will contains all the properties set to require and some other properties such as.</p>
<dl>
	<dt>stamp</dt>
		<dd>The timestamp for when the file was fetched.</dd>
	<dt>expire</dt>
		<dd>Updated to the expiration timestamp.</dd>
	<dt>data</dt>
		<dd>File contents.</dd>
</dl>
<pre><code>
	var req, ttl;
	basket.require({ url: 'jquery.min.js', key: 'jquery' });
	req = basket.get('jquery');
	// know the lifetime
	ttl = req.expire - req.stamp;
</code></pre>


<p><strong>basket.remove( key )</strong></p>

<p><em>key:</em> The key value to a local script to be removed from localStorage</p>

<p>remove() will simply remove a previously cached script from localStorage. An example of how to use it can be seen below:</p>

<pre><code>basket
	.remove('jquery.js')
	.remove('modernizr');
</code></pre>


<p><strong>basket.wait( [,callback] )</strong></p>

<p><em>callback:</em> An optional function to be executed once a script has loaded</p>

<p>When <code>wait()</code> is inserted into a chain, it informs the chain to ensure previous scripts inserted into the chain complete their loading prior to allowing the next item to load and execute. At it’s most basic, <code>wait()</code> can be used as follows:</p>

<pre><code>basket
	.require({ url: 'jquery.js' }).wait()
	.require({ url: 'jquery.plugin1.js' }, { url: 'jquery.plugin2.js' });
</code></pre>

<p>You can also specify an (optional) callback (typically an anonymous function) that will be executed in order following the previous scripts executing and before subsequent scripts in the chain are executed.</p>

<pre><code>basket
	.require({ url: 'jquery.js' }).wait()
	.require({ url: 'underscore.js' }, { url: 'app.js' })
	.wait(function(){
		var numbers = [10, 5, 100, 2, 1000];
		$('#message')
			.html('Live long and prosper, bro.
			Want the minimum value in our array? Boom:' + _.min(numbers));

	});
</code></pre>


<p>Finally, in case you're interested, here's the basket.js example that was used to power the intro to this page:</p>

<pre><code>var message, str;
basket
	.require({ url: 'test/jquery-1.7.1.min.js' }).wait()
	.require({ url: 'test/underscore-min.js' }, { url: 'test/backbone-min.js' })
	.wait(function() {
		// Backbone is now available, so let's define
		// a test model with a sample attribute

		var testModel = Backbone.Model.extend({
		  idAttribute: '_id'
		});

		// Create an instance of the model
		var myModel = new testModel({ _id: 4, name: 'Nyan Cat' });

		// Cache a reference to our message holder with jQuery
		message = $('#message');

		// Where #intro contains a template, get our templating on:

		var templateContent = $('#intro').html();
		var compiled = _.template(templateContent);
		message.html( compiled({name: myModel.get('name')}));

	});
</code></pre>


<p><strong>basket.clear( expired )</strong></p>
<p>This will remove the keys associated with basket.js. If expired is true, only expired keys will be removed.</p>
<pre>
<code> basket.clear(); </code> 
<code> basket.clear( true ); </code>
</pre>

<p>&nbsp;</p>
<h3>The Future</h3>
<p>We are currently investigating a number of different features we would like to bring to the project. Some of these include:</p>
<ul>
		<li><a href="https://github.com/addyosmani/basket.js/issues/27">Support for TTL</a></li>
		<li><a href="https://github.com/addyosmani/basket.js/issues/26">Intelligent file-versioning</a></li>
		<li><a href="https://github.com/addyosmani/basket.js/issues/25">Adding support for multiple files to <code>.require()</code></a></li>
		<li><a href="https://github.com/addyosmani/basket.js/issues/24">Performance benchmarks (compared to IndexedDB, Browser cache and more)</a></li>
</ul>

<p>&nbsp;</p>
<h3>Team, License &amp; Contribution Guide</h3>
<p>basket.js is released under an <a href="http://en.wikipedia.org/wiki/MIT_License">MIT License</a> and is currently maintained by <a href="https://github.com/addyosmani">Addy Osmani</a>, <a href="https://github.com/sindresorhus">Sindre Sorhus</a>, <a href="https://github.com/wibblymat">Mat Scales</a> and <a href="https://github.com/peol">Andrée Hansson</a>. We would also like to extend our thanks to <a href="https://github.com/rwldrn">Rick Waldron</a> for the optimizations he suggested for improving the project.</p>
<p>For more information on our style-guide and how to get involved with basket.js, please see the README in our project <a href="http://github.com/addyosmani/basket.js">repo</a>.</p>
		</div>
	</div>

	<script type="text/template" id="intro">
		<p><em>This section was rendered using the micro-templating in Underscore.js. It's just one of a number of scripts that were added to this document using basket.js when you loaded it and should now be <strong>cached</strong> in localStorage (if supported). If you visit this page again, the scripts will be loaded from there rather than being refetched. Backbone.js was also loaded and we created a new model with the name: <%= name %> (just for funsies).</em></p>
	</script>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	<script src="dist/basket.min.js"></script>
	<script>
		var message, str;

		basket
			.require({ url: "test/fixtures/jquery.min.js" }).wait()
			.require({ url: "test/fixtures/underscore-min.js" }, { url: "test/fixtures/backbone-min.js" })
			.wait(function() {

				var testModel = Backbone.Model.extend({
					idAttribute: "_id"
				});

				var myModel = new testModel({ _id: 4, name: "Nyan Cat" });

				//basket.remove('test/backbone-min.js');
				//basket.require('test/modernizr.min.js');


				message = $('#message');
				var templateContent = $('#intro').html();
				var compiled = _.template(templateContent);
				message.html( compiled({name: myModel.get('name')}));

			});

	</script>
		<a href="http://github.com/addyosmani/basket.js"><img style="position: absolute; top: 0; right: 0; border: 0;" src="asset/github-ribbon.png" alt="Fork me on GitHub"></a>
	</body>
</html>
